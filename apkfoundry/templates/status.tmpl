{# vim: set ft=jinja: #}
{#
   Parameters:
   * title: str
   * arches: List[
       name: str,
       new: int,
       started: int,
     ]
   * builders: List[Builder]
   * dispatch_online: bool
#}
{% extends "base.tmpl" %}
{%- set page = "arches" -%}
{%- block title -%}
 {{ title }}
{%- endblock -%}

{% block content %}
 <p>
  Dispatch status:
  <span class="status status-{{ "ONLINE" if dispatch_online else "OFFLINE" }}">
   {{ "ONLINE" if dispatch_online else "OFFLINE" }}
  </span>
 </p>

 <table>
  <thead>
   <tr>
    <th></th>
    {% for name, _, _ in arches %}
     <th>{{ link("jobs", name, arch=name) }}</th>
    {% endfor %}
   </tr>
  </thead>
  <tbody id="counts">
   <tr>
    <td>Waiting</td>
    {% for _, new, _ in arches %}
     <td>{{ new }}</td>
    {% endfor %}
   </tr>
   <tr>
    <td>Running</td>
    {% for _, _, started in arches %}
     <td>{{ started }}</td>
    {% endfor %}
   </tr>
  </tbody>
  {% for builder in builders %}
   <tbody class="builder">
    <tr>
     <td class="builder-name">
      {{ link("jobs", builder.name, builder=builder.name) }}
     </td>
     {% if builder.name is not none %}
      {% set status = "ONLINE" if builder.online else "OFFLINE" %}
      <td class="status status-{{ status if dispatch_online else "OFFLINE" }}" colspan="{{ arches|length }}">
       {{ status ~ ("?" if not dispatch_online else "") }} for {{ time(builder.updated) }}
      </td>
     {% else %}
      <td colspan="{{ arches|length }}"></td>
     {% endif %}
    </tr>
    {% if builder.name is not none %}
     <tr>
      <td>Status</td>
      {% for name, _, _ in arches %}
       {% if name in builder.arches %}
        {% set arch = builder.arches[name] %}
        {% if not builder.online %}
         {% set status = "OFFLINE" %}
        {% elif not arch.idle %}
         {% set status = "BUSY" %}
        {% else %}
         {% set status = "IDLE" %}
        {% endif %}
        <td class="status status-{{ status if dispatch_online else "OFFLINE" }}">
        {{ status ~ ("?" if not dispatch_online else "") }}
        </td>
       {% else %}
        <td></td>
       {% endif %}
      {% endfor %}
     </tr>
    {% endif %}
    {% set rows = builder.arches.values()|map(attribute="curr_jobs")|map("length")|max %}
    {% for i in range(0, rows) %}
     <tr>
      <td>{% if builder.name is none %}Next{% else %}Current{% endif %}</td>
      {% for name, _, _ in arches %}
       {% if name in builder.arches %}
        {% set arch = builder.arches[name] %}
        {% if arch.curr_jobs|length > i %}
         <td class="status status-{{ arch.curr_jobs[i].status }}">
          {{ link("jobs", "#" ~ arch.curr_jobs[i].id, arch.curr_jobs[i].id) }}<br>
          {{ time(arch.curr_jobs[i].updated) }}
         </td>
        {% else %}
         <td></td>
        {% endif %}
       {% else %}
        <td></td>
       {% endif %}
      {% endfor %}
     </tr>
    {% endfor %}
    {% if builder.name is not none %}
     <tr>
      <td>Previous</td>
      {% for name, _, _ in arches %}
       {% if name in builder.arches %}
        {% set arch = builder.arches[name] %}
        {% if arch.prev_job %}
         <td class="status status-{{ arch.prev_job.status }}">
          {{ link("jobs", "#" ~ arch.prev_job.id ~ ": " ~ arch.prev_job.status, arch.prev_job.id) }}<br>
          {{ time(arch.prev_job.updated) }}
         </td>
        {% else %}
         <td></td>
        {% endif %}
       {% else %}
        <td></td>
       {% endif %}
      {% endfor %}
     </tr>
    {% endif %}
   </tbody>
  {% endfor %}
 </table>
{% endblock %}
