#!/usr/bin/env python3
# SPDX-License-Identifier: GPL-2.0-only
# Copyright (c) 2019-2020 Max Rees
# See LICENSE for more information.
import argparse # ArgumentParser
import logging  # basicConfig, critical, info
import getpass  # getuser
import sys      # exit

from apkfoundry.root import listen

opts = argparse.ArgumentParser(
    description="""Launch the APK Foundry af-root daemon, which listens
    for privileged commands from containers and executes them as the
    af-root user (mapped to root inside the container)."""
)
opts.add_argument(
    "--log-level", default="INFO", choices=(
        "NOTSET",
        "DEBUG",
        "INFO",
        "WARNING",
        "ERROR",
        "CRITICAL",
    ),
    help="Python logging level",
)
opts = opts.parse_args()

logging.basicConfig(
    level=opts.log_level,
    format="%(asctime)s %(levelname)s %(message)s",
)

if getpass.getuser() != "af-root":
    logging.critical("Must be run as af-root")
    sys.exit(1)

logging.info("rootd started")
try:
    listen()
except KeyboardInterrupt:
    pass
