#!/usr/bin/env python3
# SPDX-License-Identifier: GPL-2.0-only
# Copyright (c) 2019 Max Rees
# See LICENSE for more information.
import argparse # ArgumentParser, REMAINDER
import logging  # basicConfig
import sys      # exit
from pathlib import Path

from apkfoundry.container import Container, cont_make
from apkfoundry.socket import client_init

logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s %(levelname)s %(message)s",
)

opts = argparse.ArgumentParser(
    usage="af-mkchroot [options ...] DIR BRANCH",
)
opts.add_argument(
    "-A", "--arch",
    help="APK architecture name (default: output of apk --print-arch)",
)
opts.add_argument(
    "-a", "--aportsdir",
    help="project checkout directory (default: container root /af/aports)",
)
opts.add_argument(
    "-c", "--cache",
    help="shared APK cache directory (default: disabled)",
)
opts.add_argument(
    "-r", "--repodest",
    help="package destination directory (default: container root /af/packages)",
)
opts.add_argument(
    "-S", "--setarch",
    help="setarch(8) architecture name (default: none)",
)
opts.add_argument(
    "-s", "--srcdest",
    help="source file directory (default: container root /var/cache/distfiles)",
)
opts.add_argument(
    "cdir", metavar="DIR",
    help="container directory",
)
opts.add_argument(
    "repo", metavar="REPO",
    help="initial repository (can be changed later)",
)

opts = opts.parse_args()
opts.cdir = Path(opts.cdir).resolve(strict=False)
opts.repo = opts.repo

cont_make(
    opts.cdir,
    opts.repo,
    arch=opts.arch,
    setarch=opts.setarch,
    mounts={
        "aportsdir": opts.aportsdir,
        "repodest": opts.repodest,
        "srcdest": opts.srcdest,
    },
    cache=opts.cache,
)

rc, _ = client_init(opts.cdir, bootstrap=True)
sys.exit(rc)
