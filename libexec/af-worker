#!/bin/sh -e
startdir="$1"
repo="${startdir%%/*}"

cleanup() {
	case "$AF_STATUS" in
	"")
		;;
	0)
		abuild undeps clean;;
	*)
		abuild undeps;;
	esac
}

cd "$startdir"
if abuild up2date 2>/dev/null; then
	exit 10
fi

abuild listpkg > "$AF_TASKDIR/manifest"
abuild fetch deps mkusers
trap cleanup EXIT INT TERM

if [ -x ".apkfoundry/$AF_BRANCH/pre-build" ]; then
	"./.apkfoundry/$AF_BRANCH/pre-build"
fi

set +e
(
	eval "exec $AF_ROOT_FD<&-"
	export AF_ROOT_FD=
	export ABUILD_FETCH= ADDGROUP= ADDUSER= SUDO_APK=
	export CLEANUP= ERROR_CLEANUP=
	abuild all
)
export AF_STATUS="$?"
set -e

if [ -x ".apkfoundry/$AF_BRANCH/post-build" ]; then
	"./.apkfoundry/$AF_BRANCH/post-build"
fi

arch="$(apk --print-arch)"
for apk in $(cat "$AF_TASKDIR/manifest"); do
	if ! [ -e "$REPODEST/$repo/$arch/$apk" ]; then
		continue
	fi

	mv "$REPODEST/$repo/$arch/$apk" "$AF_TASKDIR/$apk"
	ln -sr "$AF_TASKDIR/$apk" "$REPODEST/$repo/$arch/$apk"
done

if [ "$AF_STATUS" -eq 0 ]; then
	exit 0
else
	exit 11
fi
