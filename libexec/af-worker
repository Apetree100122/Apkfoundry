#!/bin/sh -e
startdir="$1"
repo="${startdir%%/*}"

cleanup() {
	case "$AF_STATUS" in
	"")
		;;
	0)
		abuild undeps clean;;
	*)
		abuild undeps;;
	esac
}

shuffle_repo() {
	local error="${1:-0}"

	arch="$(apk --print-arch)"
	for apk in $(cat "$AF_TASKDIR/manifest"); do
		if ! [ -e "$REPODEST/$repo/$arch/$apk" ]; then
			if [ "$error" -eq 0 ]; then
				printf '>>> ERROR: apk does not exist: %s' "$apk"
				error=12
				shuffle_repo "$error"
				break
			else
				printf '>>> WARNING: apk does not exist: %s' "$apk"
				continue
			fi
		fi

		mv "$REPODEST/$repo/$arch/$apk" "$AF_TASKDIR/$apk"

		if [ "$error" -eq 0 ]; then
			ln -sr "$AF_TASKDIR/$apk" "$REPODEST/$repo/$arch/$apk"
		fi
	done

	abuild index
	return "$error"
}

cd "$startdir"
if abuild up2date 2>/dev/null; then
	printf '>>> Package is up to date'
	exit 10
fi

abuild listpkg > "$AF_TASKDIR/manifest"
abuild fetch deps mkusers
trap cleanup EXIT INT TERM

if [ -x "$APORTSDIR/.apkfoundry/$AF_BRANCH/pre-build" ]; then
	"$APORTSDIR/.apkfoundry/$AF_BRANCH/pre-build"
fi

set +e
(
	eval "exec $AF_ROOT_FD<&-"
	export AF_ROOT_FD=
	export ABUILD_FETCH= ADDGROUP= ADDUSER= SUDO_APK=
	export CLEANUP= ERROR_CLEANUP=
	abuild all
)
export AF_STATUS="$?"
set -e

if [ -x "$APORTSDIR/.apkfoundry/$AF_BRANCH/post-build" ]; then
	"$APORTSDIR/.apkfoundry/$AF_BRANCH/post-build"
fi

shuffle_repo "$AF_STATUS"

if [ "$AF_STATUS" -eq 0 ]; then
	exit 0
else
	exit 11
fi
